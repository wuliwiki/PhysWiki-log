% 用百度网盘安全高效地备份文件
% 备份|百度网盘|增量备份|极速秒传

对任何人来说，文件备份有多重要这里就不多说了，有能力的同学完全可以自己搭建一个云备份系统，但本文介绍一种成本极低且安全高效的备份方案。

首先要介绍百度网盘的 “极速秒传” 功能： 当你要上传一个文件， 如果你或者其他任何百度网盘用户已经传过一个内容完全相同的文件（文件名不同没关系），那么客户端就会帮你秒传。 也就是说客户端并不需要真的把这个文件重新上传一次， 而是直接在你网盘中生成服务器上某个已有文件的 “快捷方式”。 这是一个十分强大的功能，但也有弊端： 如果百度审核出某个文件违反了 “相关规定”， 那么网盘就会将其替换成一个违规通知， 那么这个文件的所有“快捷方式”也都变成了这个通知。 另一方面，如果你的文件没有加密，你的文件可能有泄露的风险（例如账号被盗）。

这里推荐的方法是， 把要备份的文件夹（假设名为 \verb|backup|）中的每个文件都分别加密压缩， 然后上传到百度云， 将其重命名为例如 \verb|backup-2020-01-01|。 注意是每个文件压缩而不是整个文件夹压缩成一个大压缩包（方法见下文）。 如果文件夹较大，第一次上传无疑需要较长时间（因为百度云不可能已经有你加密过的文件， 无法秒传）。 但从第二次开始我们就可以 “增量备份” 了， 例如过了几天， \verb|backup| 文件夹中增添/删除/重命名了一少部分文件， 我们再次将这个文件夹的每个文件分别用\textbf{相同的密码}加密压缩再上传到百度云，重命名为 \verb|backup-2020-01-07|。 这时你会发现没有改变过的文件（包括重命名的）都会被秒传， 只有内容改变了的或者新增的文件才需要真正上传， 所以这个过程所用的时间将比第一次大大缩短！这就是为什么我们要将每个文件分别压缩而不是一起压缩。

注意无论是否秒传，百度云都会按照文件的实际大小计算你所用的空间（这也是为什么百度云能以较低的会员费提供如此巨大的空间）。 如果经过多次备份空间不够用了，那么可以在客户端上找到 “清理重复文件” 的功能， 清理时可以选择保留最新版本的文件。 清理完成后， 所有内容完全一样的文件都只会再最新版本的备份文件夹中保留， 使占用空间大大降低。 但这样的弊端是， 旧文件夹中的重复文件被删除。

\subsection{批量加密压缩文件夹中的文件}

（未完成：这里发现一个问题，似乎即使用同一个命令压缩出来的文件 hash 也是不同的， 所以并不能触发秒传， 我自己写过一个程序可以保证结果一致， 但有没有 linux 的自带程序可以办到？）

关于这个操作，相信对 Bash 命令行\upref{Linux}有一定了解的同学来说不是难事。

在 \verb|backup| 文件夹中打开 bash 命令行（Win10 系统可以使用 WSL， Mac 系统直接用 Terminal）中安装 \verb|7zip| 压缩程序：
\begin{lstlisting}[language=bash]
sudo apt install p7zip-full
\end{lstlisting}
将每个文件（包括子文件夹中的）分别用 \verb|密码| 加密压缩， 保存到 \verb|backup| 所在文件夹的 \verb|输出| 文件夹（）。
\begin{lstlisting}[language=bash]
find . -type f -exec 7z a ../输出/{}.7z -p密码 {} \;
\end{lstlisting}
要解压， 在 \verb|输出| 中打开命令行， 以下命令将每个子文件夹中的压缩包分别解压并删除压缩包
\begin{lstlisting}[language=bash]
find . -type f -name "*.7z" -execdir 7z x {} -p密码 \; -exec rm {} \;
\end{lstlisting}
