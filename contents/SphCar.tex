%球坐标与直角坐标的转换
% keys 坐标系|球坐标系|直角坐标系|矢量
% license Xiao
% type Tutor

\pentry{球坐标系的定义\nref{nod_Sph}， 四象限 Arctan 函数\nref{nod_Arctan}}{nod_97e9}

\subsection{坐标的变换}
当我们讨论球坐标和直角坐标的转换时， 通常令两个原点重合， 取极轴（$\theta = 0$） 为 $z$ 轴的正方向， $\theta = \pi/2$， $\phi = 0$ 为 $x$ 轴的正方向， $\theta = \pi/2$， $\phi = \pi/2$ 为 $y$ 轴的正方向。 这时两种坐标之间的变换关系为
\begin{equation}\label{eq_SphCar_1}
\begin{cases}
x = r\sin \theta \cos \phi \\
y = r\sin \theta \sin \phi \\
z = r\cos \theta 
\end{cases}~.
\end{equation}
\begin{equation}\label{eq_SphCar_2}
\leftgroup{
r &= \sqrt {x^2 + y^2 + z^2} \\
\theta  &= \Arctan\qty(\sqrt{x^2 + y^2}, z)\\
\phi  &= \Arctan(y, x)
}~.\end{equation}
证明见下文， 其中 $\Arctan$ 函数（也记为 $\opn{atan2}$）的定义见\autoref{eq_Arctan_1}。 注意根据\autoref{eq_SphCar_1}， 同一个直角坐标可以对应不同的极坐标， 例如将 $\phi$ 增加 $2\pi$ 的整数倍， 又例如对 $z$ 轴上的点 $\phi$ 可以取任意值。 但根据\autoref{eq_SphCar_2}， 我们可以找到两种坐标间的\enref{一一对应}{Set}关系。

\subsection{矢量分量的变换}
\pentry{三维旋转矩阵\nref{nod_Rot3D}}{nod_a73c}
在直角坐标系中， $\uvec x, \uvec y, \uvec z$ 是 $x,y,z$ 轴的三个正交归一向量， 在球坐标系中， $\uvec r, \uvec \theta, \uvec \phi$ 是三个正交归一向量（定义见\autoref{fig_Sph_1}）. 两组基底之间的变换关系为
\begin{equation}\label{eq_SphCar_3}
\begin{cases}
\uvec r = R_{11}\uvec x + R_{12}\uvec y + R_{13}\uvec z\\
\uvec \theta = R_{21}\uvec x + R_{22}\uvec y + R_{23}\uvec z\\
\uvec \phi = R_{31}\uvec x + R_{32}\uvec y + R_{33}\uvec z
\end{cases}~,
\end{equation}
\begin{equation}\label{eq_SphCar_4}
\begin{cases}
\uvec x = R_{11} \uvec r + R_{21} \uvec \theta  + R_{31} \uvec \phi \\
\uvec y = R_{12} \uvec r + R_{22} \uvec \theta  + R_{32} \uvec \phi \\
\uvec z = R_{13} \uvec r + R_{23} \uvec \theta  + R_{33} \uvec \phi
\end{cases}~.
\end{equation}
证明见下文， 其中 $\mat R$ 是关于两个角度的\enref{三维旋转矩阵}{Rot3D}
\begin{equation}\label{eq_SphCar_5}
\mat R = \pmat{
    \sin\theta\cos\phi & \sin\theta\sin\phi & \cos\theta\\
    \cos\theta\cos\phi & \cos\theta\sin\phi & -\sin\theta\\
    -\sin\phi & \cos\phi & 0
}~.
\end{equation}
这是一个单位正交矩阵， 满足 $\mat R^{-1} = \mat R\Tr$， 每行（列）都是一个单位矢量， 且行（列）之间正交。

若某点处任意矢量 $\bvec v$ 在直角坐标系和球坐标系中分别表示为（注意 $\uvec r, \uvec \theta, \uvec \phi$ 的方向和该点的位置有关）
\begin{equation}\label{eq_SphCar_7}
\bvec v = v_x \uvec x + v_y \uvec y + v_z \uvec z~,
\end{equation}
\begin{equation}\label{eq_SphCar_6}
\bvec v = v_r \uvec r + v_\theta \uvec \theta + v_\phi \uvec \phi~.
\end{equation}
则坐标变换关系可以用矩阵乘法表示
\begin{equation}\label{eq_SphCar_9}
\pmat{v_r \\ v_\theta \\ v_\phi}
= \mat R \pmat{v_x \\ v_y \\ v_z}~,
\end{equation}
\begin{equation}\label{eq_SphCar_8}
\pmat{v_x \\ v_y \\ v_z}
= \mat R\Tr \pmat{v_r \\ v_\theta \\ v_\phi}~,
\end{equation}
该关系可以用于把\enref{矢量场}{Vfield} $\bvec v(\bvec r)$ 在直角坐标系和球坐标系间变换。

\subsubsection{推导}
把空间中一点 $P$ 的位矢 $r \,\uvec r$ 分解为垂直于 $xy$ 平面的分量 $z = r\cos \theta $ 和 $xy$ 平面的分量 $r\sin \theta $。 后者又可以进而分解成 $x$ 分量 和 $y$ 分量  $x = r\sin \theta \cos \phi$，  $y = r\sin \theta \sin \phi$， 这就得到了\autoref{eq_SphCar_1}。

在直角坐标系中， 有 $r = \sqrt {x^2 + y^2 + z^2}$， 代入\autoref{eq_SphCar_1} 中的三条关系，就可以很容易解出\autoref{eq_SphCar_2} 中的三条关系。

现在推导变换关系（\autoref{eq_SphCar_3}）。由于 $\uvec r,\uvec \theta ,\uvec \phi $ 都是关于 $(r, \theta, \phi)$ 的函数， 所以在考察某一点 $(r, \theta, \phi)$ 时， 要计算 $\uvec r$ 在 $\uvec x, \uvec y, \uvec z$ 方向的投影， 可以先把 $\uvec r$ 平移使其起点为坐标原点， 那么它终点的直角坐标就是投影长度。 首先易知终点的球坐标是 $(1, \theta, \phi)$，  根据\autoref{eq_SphCar_1} 变换到直角坐标为
\begin{equation}
(\sin \theta \cos \phi,\,\sin \theta \sin \phi,\,\cos \theta)~.
\end{equation}
写成矢量的形式，就是
\begin{equation}
\uvec r = \sin \theta \cos \phi \,\uvec x + \sin \theta \sin \phi \,\uvec y + \cos \theta \,\uvec z~.
\end{equation}
至于\autoref{eq_SphCar_3} 的第二条， 要计算 $\uvec \theta$ 在 $\uvec x, \uvec y, \uvec z$ 方向的投影， 同样把起点平移到坐标原点， 由于 $\uvec \theta $ 是 $\uvec r$ 向下转动 $90^\circ$ 即 $\theta$ 增加 $\pi/2$， 所以终点的球坐标为 $(1, \theta + \pi /2, \phi)$， 根据\autoref{eq_SphCar_1} 变换到直角坐标再化简就得到
\begin{equation}
\uvec \theta  = \cos \theta \cos \phi \,\uvec x + \cos \theta \sin \phi \,\uvec y - \sin \theta \,\uvec z~.
\end{equation}
最后， $\uvec \phi$ 平移到原点后， 终点的球坐标为 $(1, \pi/2, \phi+\pi/2)$， 同理可得\autoref{eq_SphCar_3} 第三条。 将基底变换\autoref{eq_SphCar_3} 和\autoref{eq_SphCar_4} 分别代入\autoref{eq_SphCar_6} 和\autoref{eq_SphCar_7} 得坐标变换\autoref{eq_SphCar_8} 和\autoref{eq_SphCar_9}， 详见 “\enref{三维旋转矩阵}{Rot3D}”。

\subsection{两方向的夹角}
\pentry{点乘\nref{nod_Dot}}{nod_d492}
若已知球坐标系中两个方向的单位向量分别为 $(1, \theta_1, \phi_1)$ 和 $(1, \theta_2, \phi_2)$ 如何求它们之间的夹角 $\alpha$ 呢？ 我们可以先计算两个单位矢量的直角坐标， 然后对它们进行内积即可得到两矢量夹角的余弦值。 由\autoref{eq_SphCar_1}， 两矢量的直角坐标分别为
\begin{equation}
(\sin\theta_1\cos\phi_1,\ \sin\theta_1\sin\phi_1,\ \cos\theta_1)~,
\qquad
(\sin\theta_2\cos\phi_2,\ \sin\theta_2\sin\phi_2,\ \cos\theta_2)~.
\end{equation}
对它们做点乘（\autoref{eq_Dot_4}）就得到夹角的余弦值， 利用三角恒等式（\autoref{eq_TriEqv_2}）， 得
\begin{equation}\ali{
\cos\alpha &= \sin\theta_1\cos\phi_1\sin\theta_2\cos\phi_2 +  \sin\theta_1\sin\phi_1 \sin\theta_2\sin\phi_2 + \cos\theta_1 \cos\theta_2\\
&= \sin\theta_1\sin\theta_2(\cos\phi_1 \cos\phi_2 + \sin\phi_1\sin\phi_2) + \cos\theta_1 \cos\theta_2\\
&=  \sin\theta_1\sin\theta_2\cos(\phi_2-\phi_1) + \cos\theta_1 \cos\theta_2~.\\
}\end{equation}

\subsubsection{Matlab 代码}
在 Matlab 中， \verb`sph2cart` 中 $\theta$ 的定义是本文中 $\pi/2 - \theta$。 所以我们可以另外定义一个符合本文的函数
\begin{lstlisting}[language=matlab, caption=Sph2Cart.m]
% physics version of sph2cart
function [X,Y,Z] = Sph2Cart(R,Th,Ph)
[X,Y,Z] = sph2cart(Ph,pi*0.5-Th,R);
end
\end{lstlisting}
