%球坐标与直角坐标的转换
% 坐标系|球坐标系|直角坐标系|矢量

\pentry{球坐标系的定义\upref{Sph}， 四象限 Arctan 函数\upref{Arctan}}

当我们讨论球坐标和直角坐标的转换时， 通常令两个原点重合， 取极轴（$\theta = 0$） 为 $z$ 轴的正方向， $\theta = \pi/2$， $\phi = 0$ 为 $x$ 轴的正方向， $\theta = \pi/2$， $\phi = \pi/2$ 为 $y$ 轴的正方向． 这时两种坐标之间的变换关系为．
\begin{equation}\label{SphCar_eq1}
\begin{cases}
x = r\sin \theta \cos \phi \\
y = r\sin \theta \sin \phi \\
z = r\cos \theta 
\end{cases}
\end{equation}
\begin{equation}\label{SphCar_eq2}
\leftgroup{
r &= \sqrt {x^2 + y^2 + z^2} \\
\theta  &= \Arctan\qty(\sqrt{x^2 + y^2}, z)\\
\phi  &= \Arctan(y, x)
}\end{equation}
其中 $\Arctan$ 函数（也记为 $\opn{atan2}$）的定义见\autoref{Arctan_eq1}~\upref{Arctan}． 注意根据\autoref{SphCar_eq1}， 同一个直角坐标可以对应不同的极坐标， 例如将 $\phi$ 增加 $2\pi$ 的整数倍， 又例如对 $z$ 轴上的点 $\phi$ 可以取任意值． 但根据\autoref{SphCar_eq2}， 我们可以找到两种坐标间的一一对应\upref{Set}关系．

\subsection{矢量的变换}
两组基底之间的变换关系为
\begin{equation}\label{SphCar_eq3}
\begin{cases}
\uvec r = R_{11}\uvec x + R_{12}\uvec y + R_{13}\uvec z\\
\uvec \theta = R_{21}\uvec x + R_{22}\uvec y + R_{23}\uvec z\\
\uvec \phi = R_{31}\uvec x + R_{32}\uvec y + R_{33}\uvec z
\end{cases}
\end{equation}
\begin{equation}\label{SphCar_eq4}
\begin{cases}
\uvec x = R_{11} \uvec r + R_{21} \uvec \theta  + R_{31} \uvec \phi \\
\uvec y = R_{12} \uvec r + R_{22} \uvec \theta  + R_{32} \uvec \phi \\
\uvec z = R_{13} \uvec r + R_{23} \uvec \theta  + R_{33} \uvec \phi
\end{cases}
\end{equation}
其中 $\mat R$ 是关于两个角度的三维旋转矩阵\upref{Rot3D}
\begin{equation}\label{SphCar_eq5}
\mat R = \pmat{
    \sin\theta\cos\phi & \sin\theta\sin\phi & \cos\theta\\
    \cos\theta\cos\phi & \cos\theta\sin\phi & -\sin\theta\\
    -\sin\phi & \cos\phi & 0
}
\end{equation}

若某点处任意矢量 $\bvec v$ 在直角坐标系和球坐标系中分别表示为（注意 $\uvec r, \uvec \theta, \uvec \phi$ 的方向和该点的位置有关）
\begin{equation}\label{SphCar_eq7}
\bvec v = v_x \uvec x + v_y \uvec y + v_z \uvec z
\end{equation}
\begin{equation}\label{SphCar_eq6}
\bvec v = v_r \uvec r + v_\theta \uvec \theta + v_\phi \uvec \phi
\end{equation}
则坐标变换关系可以用矩阵乘法表示
\begin{equation}\label{SphCar_eq9}
\pmat{v_r \\ v_\theta \\ v_\phi}
= \mat R \pmat{v_x \\ v_y \\ v_z}
\end{equation}
\begin{equation}\label{SphCar_eq8}
\pmat{v_x \\ v_y \\ v_z}
= \mat R\Tr \pmat{v_r \\ v_\theta \\ v_\phi}
\end{equation}
该关系可以用于把矢量场\upref{Vfield} $\bvec v(\bvec r)$ 在直角坐标系和球坐标系间变换．

\subsection{推导}
把空间中一点 $P$ 的位矢 $r \,\uvec r$ 分解为垂直于 $xy$ 平面的分量 $z = r\cos \theta $ 和 $xy$ 平面的分量 $r\sin \theta $． 后者又可以进而分解成 $x$ 分量 和 $y$ 分量  $x = r\sin \theta \cos \phi$，  $y = r\sin \theta \sin \phi$， 这就得到了\autoref{SphCar_eq1}．

在直角坐标系中， 有 $r = \sqrt {x^2 + y^2 + z^2}$， 代入\autoref{SphCar_eq1} 中的三条关系，就可以很容易解出\autoref{SphCar_eq2} 中的三条关系．

现在推导变换关系（\autoref{SphCar_eq3}）．由于 $\uvec r,\uvec \theta ,\uvec \phi $ 都是关于 $(r, \theta, \phi)$ 的函数，所以在考察一点 $(r, \theta, \phi)$ 时， $\uvec r$ 的球坐标是 $(1, \theta, \phi)$，  根据\autoref{SphCar_eq1} 变换到直角坐标为
\begin{equation}
(\sin \theta \cos \phi,\,\sin \theta \sin \phi,\,\cos \theta)
\end{equation}
写成矢量的形式，就是
 \begin{equation}
\uvec r = \sin \theta \cos \phi \,\uvec x + \sin \theta \sin \phi \,\uvec y + \cos \theta \,\uvec z
\end{equation}
至于\autoref{SphCar_eq3} 的第二条式子，在同一个球坐标 $(r,\theta ,\phi)$ 处， $\uvec \theta $ 的球坐标为 $(1, \theta + \pi /2, \phi)$， 根据\autoref{SphCar_eq1} 变换到直角坐标再化简就得到直角坐标和对应的矢量形式为
\begin{equation}\label{SphCar_eq10}
(\cos \theta \cos \phi ,\,\cos \theta \sin \phi , \,- \sin \theta)
\end{equation}
\begin{equation}
\uvec \theta  = \cos \theta \cos \phi \,\uvec x + \cos \theta \sin \phi \,\uvec y - \sin \theta \,\uvec z
\end{equation}
同理可得第三条． 将基底变换\autoref{SphCar_eq3} 和\autoref{SphCar_eq4} 分别代入\autoref{SphCar_eq6} 和\autoref{SphCar_eq7} 得坐标变换\autoref{SphCar_eq8} 和\autoref{SphCar_eq9}， 详见 “三维旋转矩阵\upref{Rot3D}”．

\subsection{两方向的夹角}
\pentry{内积\upref{Dot}}
若已知球坐标系中两个方向分别为 $(1, \theta_1, \phi_1)$ 和 $(1, \theta_2, \phi_2)$ 如何求它们之间的夹角 $\alpha$ 呢？ 我们可以先计算两个单位矢量的直角坐标， 然后对它们进行内积即可得到两矢量夹角的余弦值． 由\autoref{SphCar_eq1}， 两矢量的直角坐标分别为
\begin{equation}
(\sin\theta_1\cos\phi_1,\ \sin\theta_1\sin\phi_1,\ \cos\theta_1)
\qquad
(\sin\theta_2\cos\phi_2,\ \sin\theta_2\sin\phi_2,\ \cos\theta_2)
\end{equation}
利用三角恒等式（\autoref{TriEqv_eq2}~\upref{TriEqv}）， 得
\begin{equation}\ali{
\cos\alpha &= \sin\theta_1\cos\phi_1\sin\theta_2\cos\phi_2 +  \sin\theta_1\sin\phi_1 \sin\theta_2\sin\phi_2 + \cos\theta_1 \cos\theta_2\\
&= \sin\theta_1\sin\theta_2(\cos\phi_1 \cos\phi_2 + \sin\phi_1\sin\phi_2) + \cos\theta_1 \cos\theta_2\\
&=  \sin\theta_1\sin\theta_2\cos(\phi_2-\phi_1) + \cos\theta_1 \cos\theta_2\\
}\end{equation}
